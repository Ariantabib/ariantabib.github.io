<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO & Meta Tags -->
    <title>Arian Tabib | Architect & 3D Visualizer | آرین طبیب</title>
    <meta name="title" content="Arian Tabib | Architect & 3D Visualizer | آرین طبیب">
    <meta name="description" content="Portfolio of Arian Tabib (آرین طبیب). Architectural design, interior design, and high-end CGI visualizations.">
    <meta name="keywords" content="Arian Tabib, آرین طبیب, Architect, 3D Visualizer, Interior Design, CGI, Tehran, Architecture Portfolio">
    <meta name="author" content="Arian Tabib">
    <meta name="robots" content="index, follow, max-image-preview:large">
    <meta name="language" content="English">
    
    <!-- Canonical & Favicon -->
    <link rel="canonical" href="https://ariantabib.github.io/website/">
    <link rel="icon" type="image/png" href="./images/logo.png">
    <link rel="apple-touch-icon" href="./images/logo.png">
    <meta name="theme-color" content="#050505">

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- PapaParse & Model Viewer -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@200;300;400;500;600;700&family=Vazirmatn:wght@100;300;400;500;700&display=swap" rel="stylesheet">

    <style>
        @font-face { font-family: 'Kalameh'; src: url('./fonts/KALAMEH-THIN.woff2') format('woff2'); font-weight: 100; font-display: swap; }
        @font-face { font-family: 'Kalameh'; src: url('./fonts/KALAMEH-REGULAR.woff2') format('woff2'); font-weight: 400; font-display: swap; }
        @font-face { font-family: 'Kalameh'; src: url('./fonts/KALAMEH-BOLD.woff2') format('woff2'); font-weight: 700; font-display: swap; }
        @font-face { font-family: 'Kalameh'; src: url('./fonts/KALAMEH-BLACK.woff2') format('woff2'); font-weight: 900; font-display: swap; }

        html { scroll-behavior: smooth; }
        body { font-family: 'Oxanium', sans-serif; background-color: #050505; color: #ffffff; overflow-x: hidden; cursor: none; }
        .font-fa { font-family: 'Kalameh', 'Vazirmatn', Tahoma, sans-serif; }

        /* Loading Screen */
        .loading-screen {
            position: fixed; inset: 0; z-index: 9999; background-color: #050505;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 1; visibility: visible;
            transition: opacity 1.2s cubic-bezier(0.4, 0, 0.2, 1), visibility 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .loading-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .loading-name { font-size: clamp(2rem, 8vw, 5rem); font-weight: 200; letter-spacing: 0.3em; color: #fff; opacity: 0; animation: fadeInName 1s ease forwards 0.3s; }
        .loading-line { width: 0; height: 1px; background: linear-gradient(90deg, transparent, #C1A365, transparent); margin-top: 2rem; animation: expandLine 1.5s ease forwards 0.8s; }
        .loading-subtitle { font-size: 0.75rem; letter-spacing: 0.4em; color: #C1A365; text-transform: uppercase; margin-top: 1.5rem; opacity: 0; animation: fadeInName 0.8s ease forwards 1.5s; }
        .loading-dots { display: flex; gap: 8px; margin-top: 3rem; }
        .loading-dot { width: 6px; height: 6px; background-color: #C1A365; border-radius: 50%; animation: pulse 1.4s ease-in-out infinite; }
        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes fadeInName { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes expandLine { from { width: 0; } to { width: min(300px, 60vw); } }
        @keyframes pulse { 0%, 100% { opacity: 0.3; transform: scale(1); } 50% { opacity: 1; transform: scale(1.2); } }

        /* Scroll Reveal */
        .reveal { opacity: 0; transform: translateY(30px); transition: opacity 0.6s ease-out, transform 0.6s ease-out; }
        .reveal.revealed { opacity: 1; transform: translateY(0); }

        /* Project Card */
        .project-card {
            opacity: 0; transform: translateY(25px) scale(0.98);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            height: 100%; 
        }
        .project-card.revealed { opacity: 1; transform: translateY(0) scale(1); }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #1a1a1a 25%, #252525 50%, #1a1a1a 75%);
            background-size: 200% 100%;
            animation: skeletonShimmer 1.5s ease-in-out infinite;
        }
        @keyframes skeletonShimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .skeleton-card {
            position: relative;
            overflow: hidden;
            background-color: #101010;
            border-radius: 2px;
        }
        .skeleton-card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.03), transparent);
            animation: skeletonShimmer 1.5s ease-in-out infinite;
            background-size: 200% 100%;
        }

        /* Hero Parallax */
        .hero-content { transition: transform 0.1s linear, opacity 0.1s linear; will-change: transform, opacity; }

        /* Custom Cursor - Only on devices that support hover (not touch) */
        @media (hover: hover) and (pointer: fine) {
            .cursor-dot, .cursor-outline { position: fixed; top: 0; left: 0; transform: translate(-50%, -50%); border-radius: 50%; z-index: 9998; pointer-events: none; }
            .cursor-dot { width: 6px; height: 6px; background-color: #fff; }
            .cursor-outline { width: 40px; height: 40px; border: 1px solid rgba(255, 255, 255, 0.3); transition: width 0.2s, height 0.2s, background-color 0.2s; }
            body.hovering .cursor-outline { width: 60px; height: 60px; background-color: rgba(255, 255, 255, 0.1); border-color: transparent; backdrop-filter: blur(2px); }
        }
        @media (hover: none) or (pointer: coarse) {
            body { cursor: auto; }
            .cursor-dot, .cursor-outline { display: none !important; }
        }

        /* Utilities */
        .header-fade { background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.6) 50%, transparent 100%); }
        .noise { position: fixed; inset: 0; z-index: 50; opacity: 0.03; pointer-events: none; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E"); }
        
        /* Typing Effect */
        .typing-cursor { display: inline-block; width: 2px; height: 1em; background-color: #C1A365; margin-left: 4px; animation: blink 1s step-end infinite; vertical-align: middle; }
        @keyframes blink { 50% { opacity: 0; } }

        /* Scrollbars */
        .modal-scroll::-webkit-scrollbar { width: 4px; }
        .modal-scroll::-webkit-scrollbar-track { background: #111; }
        .modal-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        .modal-scroll::-webkit-scrollbar-thumb:hover { background: #C1A365; }

        /* AR Buttons */
        .ar-buttons-container { position: absolute; top: 1rem; left: 1rem; right: 1rem; z-index: 60; display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; }
        @media (min-width: 768px) { .ar-buttons-container { top: 1.5rem; left: 1.5rem; right: 1.5rem; } }
        .ar-btn { display: flex; align-items: center; justify-content: center; gap: 0.375rem; padding: 0.5rem 0.75rem; font-size: 0.625rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; border-radius: 9999px; transition: all 0.3s ease; white-space: nowrap; flex-shrink: 0; }
        @media (min-width: 400px) { .ar-btn { padding: 0.625rem 1rem; gap: 0.5rem; font-size: 0.6875rem; } }
        @media (min-width: 768px) { .ar-btn { padding: 0.75rem 1.5rem; gap: 0.75rem; font-size: 0.75rem; } }
        .ar-btn-back { background-color: rgba(0, 0, 0, 0.8); color: #fff; border: 1px solid rgba(255, 255, 255, 0.2); backdrop-filter: blur(8px); }
        .ar-btn-back:hover { background-color: rgba(51, 51, 51, 1); }
        .ar-btn-activate { background-color: #C1A365; color: #000; border: 1px solid #C1A365; }
        .ar-btn-activate:hover { background-color: #fff; }
        .ar-btn svg { width: 14px; height: 14px; flex-shrink: 0; }
        @media (min-width: 768px) { .ar-btn svg { width: 18px; height: 18px; } }

        /* Sections */
        .timeline-item { opacity: 0; transform: translateX(-20px); transition: opacity 0.35s ease-out, transform 0.35s ease-out; }
        .timeline-item.revealed { opacity: 1; transform: translateX(0); }
        [dir="rtl"] .timeline-item { transform: translateX(20px); }
        [dir="rtl"] .timeline-item.revealed { transform: translateX(0); }
        
        .contact-card { opacity: 0; transform: translateY(20px); transition: opacity 0.35s ease-out, transform 0.35s ease-out; }
        .contact-card.revealed { opacity: 1; transform: translateY(0); }
        
        .section-title { opacity: 0; transform: translateY(20px); transition: opacity 0.4s ease-out, transform 0.4s ease-out; }
        .section-title.revealed { opacity: 1; transform: translateY(0); }
        
        .filter-bar { opacity: 0; transform: translateY(15px); transition: opacity 0.5s ease-out, transform 0.5s ease-out; }
        .filter-bar.revealed { opacity: 1; transform: translateY(0); }

        .filter-btn-active { background: linear-gradient(135deg, #C1A365 0%, #D4B978 100%); color: #000 !important; border-color: #C1A365 !important; box-shadow: 0 2px 10px rgba(193, 163, 101, 0.3); }

        /* Ken Burns */
        @keyframes kenBurnsZoom { 0% { transform: scale(1.0); } 100% { transform: scale(1.15); } }
        .hero-slide-container { position: absolute; inset: 0; overflow: hidden; }
        .hero-slide-container img, .hero-slide-container .img-blur-wrapper { width: 100%; height: 100%; object-fit: cover; }
        .hero-img-animator { width: 100%; height: 100%; will-change: transform; transform-origin: center center; }
        .hero-img-animator.active { animation: kenBurnsZoom 5s ease-out forwards; }
        .hero-img-animator.inactive { transform: scale(1.15); }

        /* Section Divider */
        .section-divider { position: relative; height: 0; display: flex; align-items: center; justify-content: center; z-index: 10; }
        .section-divider::before { content: ''; position: absolute; width: 200px; height: 1px; background: linear-gradient(90deg, transparent, #C1A365, transparent); }
        .section-divider-dot { width: 8px; height: 8px; background: #C1A365; transform: rotate(45deg); position: relative; z-index: 1; }
        .section-divider-lines { display: flex; align-items: center; gap: 12px; }
        .section-divider-line { width: 60px; height: 1px; background: linear-gradient(90deg, transparent, rgba(193, 163, 101, 0.5)); }
        .section-divider-line:last-child { background: linear-gradient(90deg, rgba(193, 163, 101, 0.5), transparent); }

        /* Mobile Bottom Nav - ONLY visible on mobile */
        .mobile-bottom-nav {
            position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(200px); z-index: 100;
            display: none; /* Hidden by default */
            align-items: center; justify-content: center; gap: 6px; padding: 10px 16px;
            background: rgba(15, 15, 15, 0.85); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 50px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.05);
            opacity: 0; visibility: hidden;
            transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.4s ease, visibility 0.4s ease;
        }
        /* Only show on mobile devices */
        @media (max-width: 767px) {
            .mobile-bottom-nav { display: flex; }
            .mobile-bottom-nav.visible { transform: translateX(-50%) translateY(0); opacity: 1; visibility: visible; }
        }
        .mobile-nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px 16px; border-radius: 24px; transition: all 0.25s ease; text-decoration: none; color: rgba(255, 255, 255, 0.5); position: relative; min-width: 56px; }
        .mobile-nav-item:active { transform: scale(0.95); }
        .mobile-nav-item.active { color: #C1A365; background: rgba(193, 163, 101, 0.15); }
        .mobile-nav-item.active::before { content: ''; position: absolute; top: 2px; left: 50%; transform: translateX(-50%); width: 20px; height: 3px; background: #C1A365; border-radius: 3px; }
        .mobile-nav-item svg { width: 22px; height: 22px; margin-bottom: 3px; transition: transform 0.25s ease; flex-shrink: 0; }
        .mobile-nav-item.active svg { transform: scale(1.1); }
        .mobile-nav-item span { font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; }
        .mobile-lang-btn { display: flex; align-items: center; justify-content: center; width: 44px; height: 44px; margin-left: 8px; padding: 0; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.12); border-radius: 50%; transition: all 0.25s ease; flex-shrink: 0; }
        .mobile-lang-btn:active { transform: scale(0.9); background: rgba(193, 163, 101, 0.2); }
        .mobile-lang-btn img { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255, 255, 255, 0.15); }

        /* LQIP Blur */
        .img-blur-wrapper { position: relative; overflow: hidden; background-color: #1a1a1a; }
        .img-blur-placeholder { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; filter: blur(20px); transform: scale(1.1); transition: opacity 0.4s ease-out; z-index: 1; }
        .img-blur-placeholder.loaded { opacity: 0; pointer-events: none; }
        .img-blur-main { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.4s ease-out; }
        .img-blur-main.loaded { opacity: 1; }

        /* Lazy Load Image */
        .lazy-image {
            opacity: 0;
            transition: opacity 0.5s ease-out;
        }
        .lazy-image.loaded {
            opacity: 1;
        }

        /* Skills Grid */
        .skills-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }
        @media (min-width: 640px) { .skills-grid { grid-template-columns: repeat(6, 1fr); gap: 1.25rem; } }
        @media (min-width: 1024px) { .skills-grid { grid-template-columns: repeat(8, 1fr); gap: 1.5rem; } }
        .skill-item { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; padding: 1rem 0.5rem; border-radius: 0.75rem; background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.3s ease; opacity: 0; transform: translateY(15px); }
        .skill-item.revealed { opacity: 1; transform: translateY(0); }
        .skill-item:hover { background: rgba(193, 163, 101, 0.1); border-color: rgba(193, 163, 101, 0.3); transform: translateY(-4px); }
        .skill-icon { width: 36px; height: 36px; object-fit: contain; filter: grayscale(100%) brightness(0.8); transition: all 0.3s ease; }
        @media (min-width: 640px) { .skill-icon { width: 44px; height: 44px; } }
        .skill-item:hover .skill-icon { filter: grayscale(0%) brightness(1); transform: scale(1.1); }
        .skill-name { font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.05em; color: rgba(255, 255, 255, 0.5); text-align: center; transition: color 0.3s ease; }
        @media (min-width: 640px) { .skill-name { font-size: 0.65rem; } }
        .skill-item:hover .skill-name { color: #C1A365; }

        /* Modal styles */

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            .hero-img-animator { animation: none !important; }
            .reveal, .project-card, .timeline-item, .contact-card, .section-title, .filter-bar, .skill-item {
                transition: opacity 0.3s ease-out !important;
                transform: none !important;
            }
            .reveal.revealed, .project-card.revealed, .timeline-item.revealed, .contact-card.revealed, .section-title.revealed, .filter-bar.revealed, .skill-item.revealed {
                opacity: 1;
            }
            .skeleton { animation: none; background: #1a1a1a; }
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { bg: '#050505', surface: '#101010', accent: '#C1A365', secondary: '#999999' },
                    spacing: { '128': '32rem' }
                }
            }
        }
    </script>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-name">ARIAN TABIB</div>
        <div class="loading-line"></div>
        <div class="loading-subtitle">Architect & 3D Visualizer</div>
        <div class="loading-dots">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
        </div>
    </div>

    <div id="root"></div>
    <div class="noise"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- HAPTIC FEEDBACK UTILITY ---
        const haptic = {
            light: () => {
                if ('vibrate' in navigator) navigator.vibrate(10);
            },
            medium: () => {
                if ('vibrate' in navigator) navigator.vibrate(20);
            },
            heavy: () => {
                if ('vibrate' in navigator) navigator.vibrate([30, 10, 30]);
            }
        };

        // --- ICONS ---
        const Icons = {
            Close: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6L6 18M6 6l12 12"/></svg>,
            ArrowDown: () => <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><path d="M12 5v14M19 12l-7 7-7-7"/></svg>,
            ArrowUp: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 15l-6-6-6 6"/></svg>,
            ArrowRight: () => <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M9 18l6-6-6-6"/></svg>,
            ArrowLeft: () => <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M15 18l-6-6 6-6"/></svg>,
            Download: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Instagram: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>,
            Linkedin: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg>,
            Youtube: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.33 29 29 0 0 0-.46-5.33z"></path><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon></svg>,
            Send: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>,
            Mail: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>,
            Phone: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>,
            AR: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M2 8V5a3 3 0 0 1 3-3h3"/><path d="M2 16v3a3 3 0 0 0 3 3h3"/><path d="M22 8V5a3 3 0 0 0-3-3h-3"/><path d="M22 16v3a3 3 0 0 1-3 3h-3"/><path d="M12 8l-4 2 4 2 4-2-4-2z"/><path d="M8 10v4l4 2 4-2v-4"/></svg>,
            Back: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>,
            Grid: () => <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>,
            User: () => <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            MessageCircle: () => <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>,
            Globe: () => <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>,
            Plus: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        };

        // --- CONTENT & DATA ---
        const content = {
            en: {
                nav: { work: "Projects", about: "About", contact: "Connect" },
                download: "Portfolio",
                hero: { 
                    name: "ARIAN TABIB", 
                    roles: ["ARCHITECT", "3D VISUALIZER", "DESIGNER"],
                    desc: "Bridging conceptual innovation with technical precision to create immersive spatial narratives.",
                    ctaPrimary: "View Projects",
                    ctaSecondary: "Resume"
                },
                showMoreBtn: "Show More Projects",
                collapseBtn: "Show Less",
                filters: { all: "All", arch: "Architecture", interior: "Interior", ai: "AI Art", exec: "Executive", cgi: "3D CGI", sketch: "Sketches", ads: "Ads" },
                contact: { title: "Let's Build Your Vision" },
                about: {
                    title: "About Me",
                    bio: "I am an architectural designer operating at the intersection of built environments and digital artistry. With a high-honors academic background and a diverse portfolio of executive projects, my work bridges the gap between conceptual innovation and technical precision.",
                    expTitle: "Work Experience",
                    eduTitle: "Education",
                    skillsTitle: "Tools & Technologies"
                },
                footer: "© 2025 Arian Tabib. All Rights Reserved."
            },
            fa: {
                nav: { work: "پروژه‌ها", about: "درباره من", contact: "ارتباط" },
                download: "پورتفولیو",
                hero: { 
                    name: "آرین طبیب", 
                    roles: ["معمار", "تصویرساز سه بعدی", "طراح"],
                    desc: "تلاقی نوآوری مفهومی و دقت فنی برای خلق روایت‌های فضایی تاثیرگذار.",
                    ctaPrimary: "مشاهده آثار",
                    ctaSecondary: "رزومه"
                },
                showMoreBtn: "مشاهده همه پروژه‌ها",
                collapseBtn: "بستن لیست",
                filters: { all: "همه", arch: "معماری", interior: "داخلی", ai: "هوش مصنوعی", exec: "اجرایی", cgi: "3D CGI", sketch: "اسکیس", ads: "تبلیغات" },
                contact: { title: "بیایید رویایی بسازیم" },
                about: {
                    title: "درباره من",
                    bio: "من طراح معماری هستم که در نقطه تلاقی محیط‌های ساخته‌شده و هنر دیجیتال فعالیت می‌کنم. با پیش‌زمینه‌ای آکادمیک و ممتاز، کار من پلی است میان نوآوری مفهومی و دقت فنی.",
                    expTitle: "سوابق کاری",
                    eduTitle: "تحصیلات",
                    skillsTitle: "ابزارها"
                },
                footer: "© ۱۴۰۳ آرین طبیب."
            }
        };

        const timelineData = {
            en: {
                experience: [
                    { role: "Visual Strategy & Advertising", company: "Mix Plus", duration: "1+ Yr" },
                    { role: "Executive Architectural Design", company: "Freelance", duration: "1.5 Yrs" },
                    { role: "Senior 3D Artist", company: "NFINITE, France", duration: "2 Yrs" },
                    { role: "Interior Designer", company: "FFA Group", duration: "1 Yr" },
                    { role: "3D Modeler", company: "Square Architect", duration: "1 Yr" }
                ],
                education: [
                    { role: "Master of Architecture", company: "Azad University, Tehran", duration: "In Progress" },
                    { role: "Bachelor of Architecture", company: "Azad University, Tehran", duration: "GPA: 17/20" }
                ]
            },
            fa: {
                experience: [
                    { role: "استراتژی بصری و تبلیغات", company: "میکس پلاس", duration: "۱+ سال" },
                    { role: "طراحی اجرایی معماری", company: "فریلنس", duration: "۱.۵ سال" },
                    { role: "هنرمند ارشد سه‌بعدی", company: "NFINITE فرانسه", duration: "۲ سال" },
                    { role: "طراح داخلی", company: "گروه FF", duration: "۱ سال" },
                    { role: "مدل‌ساز سه‌بعدی", company: "شرکت معماری مربع", duration: "۱ سال" }
                ],
                education: [
                    { role: "کارشناسی ارشد معماری", company: "دانشگاه آزاد تهران", duration: "در حال تحصیل" },
                    { role: "کارشناسی معماری", company: "دانشگاه آزاد تهران", duration: "معدل: ۱۷/۲۰" }
                ]
            }
        };

        const heroImages = {
            desktop: ["./images/hero-desktop-1.jpg", "./images/hero-desktop-2.jpg", "./images/hero-desktop-3.jpg"],
            mobile: ["./images/hero-mobile-1.jpg", "./images/hero-mobile-2.jpg", "./images/hero-mobile-3.jpg"]
        };

        const skillsData = [
            { id: "autocad", name: "AutoCAD", icon: "./images/skills/autocad.png" },
            { id: "revit", name: "Revit", icon: "./images/skills/revit.png" },
            { id: "3dsmax", name: "3Ds Max", icon: "./images/skills/3dsmax.png" },
            { id: "vray", name: "V-Ray", icon: "./images/skills/vray.png" },
            { id: "unreal", name: "Unreal Engine", icon: "./images/skills/unreal.png" },
            { id: "lumion", name: "Lumion", icon: "./images/skills/lumion.png" },
            { id: "photoshop", name: "Photoshop", icon: "./images/skills/photoshop.png" },
            { id: "premiere", name: "Premiere", icon: "./images/skills/premiere.png" },
            { id: "illustrator", name: "Illustrator", icon: "./images/skills/illustrator.png" },
            { id: "aftereffects", name: "After Effects", icon: "./images/skills/aftereffects.png" },
            { id: "substance", name: "Substance", icon: "./images/skills/substance.png" },
            { id: "coreldraw", name: "CorelDRAW", icon: "./images/skills/coreldraw.png" },
            { id: "aiimage", name: "AI Image", icon: "./images/skills/aiimage.png" },
            { id: "aivideo", name: "AI Video", icon: "./images/skills/aivideo.png" },
            { id: "coding", name: "Coding", icon: "./images/skills/coding.png" },
            { id: "ar", name: "AR", icon: "./images/skills/ar.png" },
            { id: "vr", name: "VR", icon: "./images/skills/vr.png" }
        ];

        // --- COMPONENTS ---
        const SectionDivider = ({ className = "" }) => (
            <div className={`section-divider ${className}`}>
                <div className="section-divider-lines">
                    <div className="section-divider-line"></div>
                    <div className="section-divider-dot"></div>
                    <div className="section-divider-line"></div>
                </div>
            </div>
        );

        // --- LAZY IMAGE COMPONENT with Intersection Observer ---
        const LazyImage = ({ src, alt, className, onLoad: externalOnLoad, ...props }) => {
            const [isLoaded, setIsLoaded] = useState(false);
            const [isInView, setIsInView] = useState(false);
            const [placeholder, setPlaceholder] = useState('');
            const imgRef = useRef(null);
            const containerRef = useRef(null);

            // Intersection Observer for lazy loading
            useEffect(() => {
                const observer = new IntersectionObserver(
                    (entries) => {
                        entries.forEach((entry) => {
                            if (entry.isIntersecting) {
                                setIsInView(true);
                                observer.unobserve(entry.target);
                            }
                        });
                    },
                    { rootMargin: '100px', threshold: 0.01 }
                );

                if (containerRef.current) {
                    observer.observe(containerRef.current);
                }

                return () => observer.disconnect();
            }, []);

            // Generate placeholder
            useEffect(() => {
                if (!isInView) return;
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => {
                    const aspectRatio = img.height / img.width;
                    canvas.width = 20;
                    canvas.height = Math.round(20 * aspectRatio);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    try {
                        setPlaceholder(canvas.toDataURL('image/jpeg', 0.5));
                    } catch (e) {
                        setPlaceholder('');
                    }
                };
                img.onerror = () => setPlaceholder('');
                img.src = src;
            }, [src, isInView]);

            const handleLoad = () => {
                setIsLoaded(true);
                if (externalOnLoad) externalOnLoad();
            };

            return (
                <div ref={containerRef} className="img-blur-wrapper" style={{ width: '100%', height: '100%' }}>
                    {placeholder && (
                        <img
                            src={placeholder}
                            alt=""
                            className={`img-blur-placeholder ${isLoaded ? 'loaded' : ''}`}
                            aria-hidden="true"
                        />
                    )}
                    {isInView && (
                        <img
                            ref={imgRef}
                            src={src}
                            alt={alt}
                            className={`img-blur-main ${isLoaded ? 'loaded' : ''} ${className || ''}`}
                            onLoad={handleLoad}
                            {...props}
                        />
                    )}
                </div>
            );
        };

        // --- SKELETON COMPONENT ---
        const ProjectSkeleton = ({ isLarge = false }) => (
            <div className={`skeleton-card ${isLarge ? 'col-span-2 row-span-2' : 'col-span-1 row-span-1'}`}>
                <div className="w-full h-full min-h-[200px] skeleton"></div>
            </div>
        );

        const MobileBottomNav = ({ activeSection, onNavigate, lang, onLangToggle, isRTL, isVisible }) => {
            const navOrder = ['work', 'contact', 'about'];
            
            const handleNavClick = (e, key) => {
                haptic.light();
                onNavigate(e, key);
            };

            const handleLangToggle = () => {
                haptic.medium();
                onLangToggle();
            };
            
            return (
                <nav className={`mobile-bottom-nav ${isVisible ? 'visible' : ''}`}>
                    {navOrder.map((key) => (
                        <a key={key} href={`#${key}`} onClick={(e) => handleNavClick(e, key)} className={`mobile-nav-item ${activeSection === key ? 'active' : ''}`}>
                            {key === 'work' && <Icons.Grid />}
                            {key === 'about' && <Icons.User />}
                            {key === 'contact' && <Icons.MessageCircle />}
                            <span className={`font-bold ${isRTL ? 'font-fa' : ''}`}>{content[lang].nav[key]}</span>
                        </a>
                    ))}
                    <button onClick={handleLangToggle} className="mobile-lang-btn" aria-label="Switch Language">
                        <img src="./images/flag.jpg" onError={(e) => { e.target.onerror = null; e.target.src = `https://placehold.co/40x40/222/C1A365?text=${lang === 'en' ? 'ف' : 'E'}`; }} alt="Lang" />
                    </button>
                </nav>
            );
        };

        const socialLinks = [
            { icon: <Icons.Mail />, label: "Email", href: "mailto:arian.tabib@gmail.com", text: "arian.tabib@gmail.com" },
            { icon: <Icons.Phone />, label: "Mobile", href: "tel:+989392263236", text: "+98 939 226 3236" },
            { icon: <Icons.Send />, label: "Telegram", href: "https://t.me/ariantabib", text: "@ariantabib" },
            { icon: <Icons.Instagram />, label: "Instagram", href: "https://instagram.com/Arian_tabib", text: "@Arian_tabib" },
            { icon: <Icons.Youtube />, label: "YouTube", href: "https://youtube.com/@Ariantabib", text: "@Ariantabib" },
            { icon: <Icons.Linkedin />, label: "LinkedIn", href: "https://linkedin.com/in/arian-tabib", text: "Arian Tabib" },
        ];

        // --- APP ---
        const App = () => {
            const [lang, setLang] = useState('en');
            const [currentSlide, setCurrentSlide] = useState(0);
            const [filter, setFilter] = useState('all');
            const [selectedProject, setSelectedProject] = useState(null);
            const [modalImageIndex, setModalImageIndex] = useState(0);
            const [isImageLoading, setIsImageLoading] = useState(false);
            const [showAR, setShowAR] = useState(false); 
            const [isLoaded, setIsLoaded] = useState(false);
            const [projectsData, setProjectsData] = useState([]);
            const [dataFetched, setDataFetched] = useState(false);
            
            const [heroScale, setHeroScale] = useState(1);
            const [heroOpacity, setHeroOpacity] = useState(1);
            const [isMobile, setIsMobile] = useState(false);
            const [isIPhone, setIsIPhone] = useState(false);
            const [usdzDownloadProgress, setUsdzDownloadProgress] = useState(0);
            const [isDownloadingUsdz, setIsDownloadingUsdz] = useState(false);
            
            // Typewriter
            const [text, setText] = useState('');
            const [roleIndex, setRoleIndex] = useState(0);
            const [isDeleting, setIsDeleting] = useState(false);
            const [typingSpeed, setTypingSpeed] = useState(150);

            const cursorDotRef = useRef(null);
            const cursorOutlineRef = useRef(null);
            const modelViewerRef = useRef(null);
            const heroContentRef = useRef(null);

            const [activeSection, setActiveSection] = useState('work');
            const [mobileNavVisible, setMobileNavVisible] = useState(false);
            
            const [showAllProjects, setShowAllProjects] = useState(false);

            // Modal state (swipe-to-close removed)

            const t = content[lang];
            const timeline = timelineData[lang];
            const isRTL = lang === 'fa';

            const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRG5pVpEgdXTzjQlWZBBU5aSNuCQNDGxbZ1DtICEH1htnaPoTFMHUT-0VWIaguFvb2VAEb8rm_3iVCd/pub?gid=0&single=true&output=csv";

            useEffect(() => {
                const fetchProjects = async () => {
                    try {
                        const response = await fetch(GOOGLE_SHEET_CSV_URL);
                        const csvText = await response.text();
                        const parsedData = Papa.parse(csvText, { header: true, skipEmptyLines: true });
                        const transformedProjects = parsedData.data.map((row, index) => {
                            const id = row.ID ? row.ID.trim() : index + 1;
                            const galleryCount = parseInt(row.Gallery_Count || 0);
                            const galleryPaths = [];
                            if (galleryCount > 0) {
                                for (let i = 1; i <= galleryCount; i++) galleryPaths.push(`./images/project${id}-gallery${i}.jpg`);
                            } else {
                                galleryPaths.push(`./images/project${id}-gallery.jpg`);
                            }
                            const tagsArray = row.Tags ? row.Tags.split(',').map(tag => tag.trim().toLowerCase()) : [];
                            const hasAR = row.HasAR && row.HasAR.toLowerCase() === 'true';
                            const size = parseInt(row.Size || 1);
                            const isFeatured = row.Featured && row.Featured.toLowerCase() === 'true';
                            
                            return {
                                id: id, order: parseInt(row.Order || 999),
                                title: { en: row.Title_EN || "Untitled", fa: row.Title_Fa || "بدون عنوان" },
                                desc: { en: row.Desc_EN || "", fa: row.Desc_Fa || "" },
                                tags: tagsArray, loc: row.Loc || "",
                                img: `./images/project${id}-img.jpg`,
                                hasAR: hasAR,
                                modelGLB: hasAR ? `./models/project${id}.glb` : null,
                                modelUSDZ: hasAR ? `./models/project${id}.usdz` : null,
                                gallery: galleryPaths,
                                size: size,
                                isFeatured: isFeatured
                            };
                        }).filter(p => p.title.en !== "Untitled" || p.title.fa !== "بدون عنوان");
                        
                        if (transformedProjects.length > 0 && !transformedProjects.some(p => p.isFeatured)) {
                            transformedProjects[0].isFeatured = true;
                        }

                        transformedProjects.sort((a, b) => a.order - b.order);
                        setProjectsData(transformedProjects);
                        setDataFetched(true);
                    } catch (error) {
                        console.error("Error fetching projects:", error);
                        setDataFetched(true);
                    }
                };
                fetchProjects();
            }, []);

            useEffect(() => {
                const checkMobile = () => setIsMobile(window.innerWidth < 768);
                checkMobile();
                window.addEventListener('resize', checkMobile);
                return () => window.removeEventListener('resize', checkMobile);
            }, []);

            useEffect(() => {
                const userAgent = navigator.userAgent || navigator.vendor || window.opera;
                setIsIPhone(/iPhone/i.test(userAgent) && !window.MSStream);
            }, []);

            useEffect(() => {
                const timer = setTimeout(() => {
                    setIsLoaded(true);
                    document.getElementById('loading-screen').classList.add('hidden');
                }, 2800);
                return () => clearTimeout(timer);
            }, []);

            useEffect(() => {
                const handleScroll = () => {
                    const scrollY = window.scrollY;
                    const windowHeight = window.innerHeight;
                    const scrollProgress = Math.min(scrollY / (windowHeight * 0.6), 1);
                    const scale = 1 - (scrollProgress * 0.15);
                    const opacity = 1 - (scrollProgress * 0.8);
                    setHeroScale(scale);
                    setHeroOpacity(opacity);
                    
                    setMobileNavVisible(scrollY > windowHeight * 0.8);

                    const sections = ['work', 'about', 'contact'];
                    for (const sectionId of sections) {
                        const section = document.getElementById(sectionId);
                        if (section) {
                            const rect = section.getBoundingClientRect();
                            if (rect.top <= windowHeight / 2 && rect.bottom >= windowHeight / 2) {
                                setActiveSection(sectionId);
                                break;
                            }
                        }
                    }
                };
                window.addEventListener('scroll', handleScroll, { passive: true });
                return () => window.removeEventListener('scroll', handleScroll);
            }, []);

            useEffect(() => {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach((entry) => {
                        if (entry.isIntersecting) entry.target.classList.add('revealed');
                        else entry.target.classList.remove('revealed');
                    });
                }, { threshold: 0.05, rootMargin: '0px 0px -20px 0px' });

                const elements = document.querySelectorAll('.reveal, .project-card, .timeline-item, .contact-card, .section-title, .filter-bar, .skill-item');
                elements.forEach((el) => observer.observe(el));
                return () => observer.disconnect();
            }, [showAllProjects, filter, dataFetched, projectsData]); 

            useEffect(() => {
                const cards = document.querySelectorAll('.project-card');
                cards.forEach((card, index) => {
                    const delay = Math.min(index * 0.05, 0.4); 
                    card.style.transitionDelay = `${delay}s`;
                });
            }, [showAllProjects, filter, projectsData]);

            useEffect(() => {
                const roles = t.hero.roles;
                const currentRole = roles[roleIndex];
                const handleTyping = () => {
                    if (isDeleting) {
                        setText(currentRole.substring(0, text.length - 1));
                        setTypingSpeed(50);
                    } else {
                        setText(currentRole.substring(0, text.length + 1));
                        setTypingSpeed(150);
                    }
                    if (!isDeleting && text === currentRole) {
                        setTimeout(() => setIsDeleting(true), 2000);
                    } else if (isDeleting && text === '') {
                        setIsDeleting(false);
                        setRoleIndex((prev) => (prev + 1) % roles.length);
                    }
                };
                const timer = setTimeout(handleTyping, typingSpeed);
                return () => clearTimeout(timer);
            }, [text, isDeleting, roleIndex, t.hero.roles]);

            useEffect(() => {
                const moveCursor = (e) => {
                    const { clientX: x, clientY: y } = e;
                    if (cursorDotRef.current) { cursorDotRef.current.style.left = `${x}px`; cursorDotRef.current.style.top = `${y}px`; }
                    if (cursorOutlineRef.current) { cursorOutlineRef.current.animate({ left: `${x}px`, top: `${y}px` }, { duration: 500, fill: "forwards" }); }
                };
                window.addEventListener('mousemove', moveCursor);
                return () => window.removeEventListener('mousemove', moveCursor);
            }, []);

            const handleHover = (isEntering) => {
                if (isEntering) document.body.classList.add('hovering');
                else document.body.classList.remove('hovering');
            };

            useEffect(() => {
                const interval = setInterval(() => setCurrentSlide((prev) => (prev + 1) % heroImages.desktop.length), 6000);
                return () => clearInterval(interval);
            }, []);

            useEffect(() => {
                if (!selectedProject) return;
                const handleKeyDown = (e) => {
                    if (showAR) return;
                    switch(e.key) {
                        case 'Escape': closeModal(); break;
                        case 'ArrowRight': e.preventDefault(); nextMedia(); break;
                        case 'ArrowLeft': e.preventDefault(); prevMedia(); break;
                        default: break;
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [selectedProject, showAR, modalImageIndex]);

            useEffect(() => {
                const modelViewer = modelViewerRef.current;
                if (showAR && modelViewer) {
                    setIsImageLoading(true);
                    setLoadProgress(0);
                    const handleProgress = (event) => {
                        const progress = event.detail.totalProgress;
                        if (typeof progress === 'number') setLoadProgress(Math.round(progress * 100));
                    };
                    const handleLoad = () => {
                        setLoadProgress(100);
                        setTimeout(() => { setIsImageLoading(false); }, 500);
                    };
                    modelViewer.addEventListener('progress', handleProgress);
                    modelViewer.addEventListener('load', handleLoad);
                    if (modelViewer.loaded) { setLoadProgress(100); setTimeout(() => { setIsImageLoading(false); }, 500); }
                    return () => {
                        modelViewer.removeEventListener('progress', handleProgress);
                        modelViewer.removeEventListener('load', handleLoad);
                    };
                }
            }, [showAR, selectedProject, lang]);
            
            const [loadProgress, setLoadProgress] = useState(0);

            const scrollToTop = (e) => { e.preventDefault(); window.scrollTo({ top: 0, behavior: 'smooth' }); };
            const scrollToProjects = () => { 
                haptic.light();
                document.getElementById('work').scrollIntoView({ behavior: 'smooth' }); 
            };
            const handleNavClick = (e, targetId) => {
                e.preventDefault();
                const element = document.getElementById(targetId);
                if (element) element.scrollIntoView({ behavior: 'smooth' });
            };

            const nextMedia = (e) => {
                if (e) e.stopPropagation();
                haptic.light();
                if (selectedProject) {
                    const totalMedia = selectedProject.gallery.length + (selectedProject.video ? 1 : 0);
                    setModalImageIndex((prev) => (prev + 1) % totalMedia);
                    if (!showAR) setIsImageLoading(true);
                }
            };

            const prevMedia = (e) => {
                if (e) e.stopPropagation();
                haptic.light();
                if (selectedProject) {
                    const totalMedia = selectedProject.gallery.length + (selectedProject.video ? 1 : 0);
                    setModalImageIndex((prev) => (prev - 1 + totalMedia) % totalMedia);
                    if (!showAR) setIsImageLoading(true);
                }
            };

            // Gallery swipe (horizontal)
            const [touchStart, setTouchStart] = useState(null);
            const [touchEnd, setTouchEnd] = useState(null);
            const minSwipeDistance = 50;

            const onTouchStart = (e) => { 
                if (showAR) return; 
                setTouchEnd(null); 
                setTouchStart(e.targetTouches[0].clientX); 
            };
            const onTouchMove = (e) => { 
                if (showAR) return; 
                setTouchEnd(e.targetTouches[0].clientX); 
            };
            const onTouchEnd = () => {
                if (showAR) return;
                if (!touchStart || !touchEnd) return;
                const distance = touchStart - touchEnd;
                if (distance > minSwipeDistance) nextMedia();
                if (distance < -minSwipeDistance) prevMedia();
            };

            // Modal close function
            

            const closeModal = () => {
                setSelectedProject(null);
                setShowAR(false);
            };

            const openProject = (project) => {
                haptic.light();
                setSelectedProject(project);
                setModalImageIndex(0);
                setIsImageLoading(true);
                setShowAR(false);
            };

            const handleImageLoad = () => { setIsImageLoading(false); };

            const handleIPhoneAR = async (usdzUrl) => {
                haptic.medium();
                setIsDownloadingUsdz(true);
                setUsdzDownloadProgress(0);
                try {
                    const response = await fetch(usdzUrl);
                    if (!response.ok) throw new Error('Failed to fetch USDZ');
                    const contentLength = response.headers.get('content-length');
                    const total = contentLength ? parseInt(contentLength, 10) : 0;
                    let loaded = 0;
                    const reader = response.body.getReader();
                    const chunks = [];
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        chunks.push(value);
                        loaded += value.length;
                        if (total > 0) setUsdzDownloadProgress(Math.round((loaded / total) * 100));
                        else setUsdzDownloadProgress(Math.min(loaded / 1000000 * 100, 95));
                    }
                    setUsdzDownloadProgress(100);
                    const blob = new Blob(chunks, { type: 'model/vnd.usdz+zip' });
                    const blobUrl = URL.createObjectURL(blob);
                    const anchor = document.createElement('a');
                    anchor.setAttribute('rel', 'ar');
                    anchor.setAttribute('href', blobUrl);
                    const img = document.createElement('img');
                    img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                    img.style.width = '1px'; img.style.height = '1px';
                    anchor.appendChild(img);
                    document.body.appendChild(anchor);
                    anchor.click();
                    setTimeout(() => { document.body.removeChild(anchor); URL.revokeObjectURL(blobUrl); }, 1000);
                } catch (error) {
                    console.error('Error downloading USDZ:', error);
                    alert(lang === 'en' ? 'Failed to load AR model.' : 'خطا در بارگذاری مدل AR.');
                } finally {
                    setTimeout(() => { setIsDownloadingUsdz(false); setUsdzDownloadProgress(0); }, 500);
                }
            };

            const handleARButtonClick = () => {
                haptic.medium();
                if (isIPhone && selectedProject.modelUSDZ) handleIPhoneAR(selectedProject.modelUSDZ);
                else setShowAR(true);
            };

            // FIX: Close AR view properly without triggering AR again
            const handleCloseARView = (e) => {
                e.preventDefault();
                e.stopPropagation();
                haptic.light();
                setShowAR(false);
            };

            const handleBackdropClick = (e) => {
                if (e.target === e.currentTarget) { 
                    haptic.light();
                    closeModal(); 
                }
            };

            const filteredProjects = projectsData
                .filter(p => filter === 'all' || p.tags.includes(filter))
                .sort((a, b) => a.order - b.order);

            const featuredProjects = filteredProjects.filter(p => p.isFeatured);
            const projectsToRender = showAllProjects ? filteredProjects : featuredProjects;
            
            const hasFeaturedProjects = featuredProjects.length > 0;
            const hasMoreProjects = filteredProjects.length > featuredProjects.length;

            // Modal opacity (fixed, no drag)
            const modalOpacity = 1;

            return (
                <div className={`min-h-screen ${isRTL ? 'font-fa' : ''}`} dir={isRTL ? 'rtl' : 'ltr'}>
                    {/* Cursor - Only on non-touch devices */}
                    <div ref={cursorDotRef} className="cursor-dot hidden md:block"></div>
                    <div ref={cursorOutlineRef} className="cursor-outline hidden md:block"></div>

                    {/* --- HEADER --- */}
                    <header className="fixed top-0 w-full z-40 py-6 header-fade transition-all duration-500">
                        <div className="container mx-auto px-6 md:px-12 flex justify-between items-center">
                            <a href="#" onClick={scrollToTop} className="z-50 block w-10 h-10 md:w-12 md:h-12 cursor-none" onMouseEnter={() => handleHover(true)} onMouseLeave={() => handleHover(false)}>
                                <img src="./images/logo.png" onError={(e) => { e.target.onerror = null; e.target.src = "https://placehold.co/100x100/white/black?text=AT"; }} alt="Arian Tabib" className="w-full h-full object-contain" />
                            </a>
                            <nav className="hidden md:flex items-center gap-8">
                                {['work', 'contact', 'about'].map((key) => (
                                    <a key={key} href={`#${key}`} onClick={(e) => handleNavClick(e, key)} className={`text-[10px] md:text-xs font-bold uppercase ${isRTL ? 'tracking-normal font-fa md:font-bold' : 'tracking-[0.2em]'} text-white/60 hover:text-white transition-colors`} onMouseEnter={() => handleHover(true)} onMouseLeave={() => handleHover(false)}>
                                        {t.nav[key]}
                                    </a>
                                ))}
                                <a href="./docs/portfolio.pdf" download className={`flex items-center gap-2 text-[10px] md:text-xs font-light uppercase ${isRTL ? 'tracking-normal font-fa md:font-bold' : 'tracking-[0.2em]'} text-accent hover:text-white transition-colors border border-white/10 hover:border-accent px-4 py-2 rounded-full`} onMouseEnter={() => handleHover(true)} onMouseLeave={() => handleHover(false)}>
                                    <span>{t.download}</span>
                                    <Icons.Download />
                                </a>
                                <button onClick={() => setLang(lang === 'en' ? 'fa' : 'en')} className="w-6 h-6 md:w-8 md:h-8 rounded-full overflow-hidden border border-white/10 hover:scale-110 transition-transform" onMouseEnter={() => handleHover(true)} onMouseLeave={() => handleHover(false)}>
                                    <img src="./images/flag.jpg" onError={(e) => { e.target.onerror = null; e.target.src = "https://placehold.co/50x50/white/black?text=" + (lang === 'en' ? 'FA' : 'EN'); }} alt="Switch Language" className="w-full h-full object-cover" />
                                </button>
                            </nav>
                        </div>
                    </header>

                    {/* --- HERO --- */}
                    <section className="relative h-screen w-full overflow-hidden flex flex-col justify-center items-center text-center px-4 md:px-6">
                        {heroImages.desktop.map((img, index) => {
                            const isActive = currentSlide === index;
                            return (
                                <div key={`desktop-${index}`} className={`hero-slide-container transition-opacity duration-[1200ms] ease-in-out hidden md:block ${isActive ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} style={{ zIndex: isActive ? 2 : 1 }}>
                                    <div className="absolute inset-0 bg-black/70 z-10"></div>
                                    <div className={`hero-img-animator ${isActive ? 'active' : 'inactive'}`}>
                                        <LazyImage src={img} alt="Hero" />
                                    </div>
                                </div>
                            );
                        })}
                        {heroImages.mobile.map((img, index) => {
                            const isActive = currentSlide === index;
                            return (
                                <div key={`mobile-${index}`} className={`hero-slide-container transition-opacity duration-[1200ms] ease-in-out md:hidden ${isActive ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} style={{ zIndex: isActive ? 2 : 1 }}>
                                    <div className="absolute inset-0 bg-black/70 z-10"></div>
                                    <div className={`hero-img-animator ${isActive ? 'active' : 'inactive'}`}>
                                        <LazyImage src={img} alt="Hero" />
                                    </div>
                                </div>
                            );
                        })}
                        <div ref={heroContentRef} className="relative z-20 max-w-4xl flex flex-col items-center hero-content" style={{ transform: `scale(${heroScale}) translateY(${(1 - heroScale) * -50}px)`, opacity: heroOpacity }}>
                            <h1 className={`text-white tracking-tight leading-none mb-3 md:mb-4 text-3xl md:text-5xl lg:text-7xl ${isRTL ? 'font-bold font-fa text-4xl md:text-6xl lg:text-8xl' : 'font-light'}`}>
                                {t.hero.name}
                            </h1>
                            
                            <div className={`text-xs md:text-lg text-white/80 font-light min-h-[1.5em] mb-4 md:mb-6 uppercase ${isRTL ? 'tracking-normal font-bold font-fa text-lg md:text-2xl' : 'tracking-[0.2em]'}`}>
                                {text}<span className="typing-cursor"></span>
                            </div>
                            
                            <p className={`text-white text-[10px] md:text-sm max-w-xl leading-relaxed mb-8 md:mb-10 ${isRTL ? 'font-bold font-fa' : 'font-light'}`}>
                                {t.hero.desc}
                            </p>
                            
                            <div className="flex flex-row justify-center gap-3 md:gap-4 w-full sm:w-auto">
                                <button onClick={scrollToProjects} className={`px-6 py-2 md:px-8 md:py-2.5 border border-white/30 text-white font-bold uppercase tracking-widest rounded-full hover:bg-white hover:text-black hover:border-white transition-all duration-300 ${isRTL ? 'text-[11px] md:text-[15px] font-fa' : 'text-[10px] md:text-sm'}`}>
                                    {t.hero.ctaPrimary}
                                </button>
                                <a href="./docs/portfolio.pdf" download onClick={() => haptic.light()} className={`px-6 py-2 md:px-8 md:py-2.5 border border-white/10 text-white font-bold uppercase tracking-widest rounded-full hover:border-accent hover:text-accent transition-all duration-300 ${isRTL ? 'text-[11px] md:text-[15px] font-fa' : 'text-[10px] md:text-sm'}`}>
                                    {t.hero.ctaSecondary}
                                </a>
                            </div>
                        </div>
                        <div className="absolute bottom-12 left-0 right-0 z-20 flex justify-center" style={{ opacity: heroOpacity }}>
                            <button onClick={scrollToProjects} className="text-white/30 hover:text-white transition-colors animate-bounce cursor-none" onMouseEnter={() => handleHover(true)} onMouseLeave={() => handleHover(false)}>
                                <Icons.ArrowDown />
                            </button>
                        </div>
                    </section>

                    {/* Section Divider */}
                    <SectionDivider />

                    {/* --- PROJECTS --- */}
                    <section id="work" className="pt-12 pb-12 px-4 md:px-12 container mx-auto">
                        
                        {showAllProjects && (
                            <div className="filter-bar flex flex-wrap gap-4 gap-y-3 mb-12 justify-center md:justify-start pb-4 border-b border-white/10">
                                {Object.keys(t.filters).map((key) => (
                                    <button key={key} onClick={() => { haptic.light(); setFilter(key); }} className={`text-[10px] md:text-xs font-light uppercase ${isRTL ? 'tracking-normal font-fa font-bold md:font-bold' : 'tracking-widest'} transition-all duration-300 px-3 py-1 md:px-4 md:py-1.5 rounded-full border ${filter === key ? 'filter-btn-active' : 'border-white/10 text-secondary hover:text-white hover:border-white/30'}`} onMouseEnter={() => handleHover(true)} onMouseLeave={() => handleHover(false)}>
                                        {t.filters[key]}
                                    </button>
                                ))}
                            </div>
                        )}

                        {!dataFetched ? (
                            // Skeleton Loading
                            <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-4 gap-4 auto-rows-[minmax(200px,_1fr)] grid-flow-dense">
                                <ProjectSkeleton isLarge={true} />
                                <ProjectSkeleton />
                                <ProjectSkeleton />
                                <ProjectSkeleton isLarge={true} />
                                <ProjectSkeleton />
                                <ProjectSkeleton />
                            </div>
                        ) : (
                            <>
                                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-4 gap-4 auto-rows-[minmax(200px,_1fr)] grid-flow-dense">
                                    {projectsToRender.map((project, index) => {
                                        const isLarge = project.size === 2;
                                        return (
                                            <div 
                                                key={project.id} 
                                                className={`project-card group relative cursor-none overflow-hidden bg-surface
                                                    ${isLarge ? 'col-span-2 row-span-2' : 'col-span-1 row-span-1'}
                                                `}
                                                onClick={() => openProject(project)} 
                                                onMouseEnter={() => handleHover(true)} onMouseLeave={() => handleHover(false)}
                                            >
                                                <div className="w-full h-full transition-transform duration-700 group-hover:scale-105">
                                                    <LazyImage src={project.img} alt={project.title[lang]} className="opacity-90 group-hover:opacity-100" />
                                                </div>
                                                <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-4 md:p-6">
                                                    <span className={`text-accent text-[9px] md:text-[10px] uppercase ${isRTL ? 'tracking-normal font-fa font-bold' : 'tracking-widest'} mb-1`}>{project.loc}</span>
                                                    <h3 className={`text-xs md:text-sm font-light text-white leading-tight ${isRTL ? 'font-fa md:font-bold' : ''}`}>{project.title[lang]}</h3>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>

                                <div className="mt-12 flex flex-col items-center gap-4 reveal">
                                    {!showAllProjects && hasMoreProjects && hasFeaturedProjects && (
                                        <button 
                                            onClick={() => { haptic.medium(); setShowAllProjects(true); }} 
                                            className={`group flex items-center gap-3 px-8 py-3 border border-white/20 text-white/70 text-xs font-light uppercase tracking-widest rounded-full hover:border-accent hover:text-accent hover:bg-white/5 transition-all duration-300 ${isRTL ? 'font-fa font-bold' : ''}`}
                                            onMouseEnter={() => handleHover(true)} onMouseLeave={() => handleHover(false)}
                                        >
                                            <span>{t.showMoreBtn}</span>
                                            <div className="w-5 h-5 flex items-center justify-center rounded-full border border-white/20 group-hover:border-accent transition-colors">
                                                <Icons.Plus />
                                            </div>
                                        </button>
                                    )}

                                    {showAllProjects && hasMoreProjects && (
                                        <button 
                                            onClick={() => {
                                                haptic.light();
                                                setShowAllProjects(false);
                                                window.scrollTo({ top: document.getElementById('work').offsetTop - 100, behavior: 'smooth' });
                                            }} 
                                            className={`flex items-center gap-2 text-white/40 text-[10px] font-light uppercase tracking-widest hover:text-accent transition-all duration-300 ${isRTL ? 'font-fa font-bold' : ''}`}
                                            onMouseEnter={() => handleHover(true)} onMouseLeave={() => handleHover(false)}
                                        >
                                            <span>{t.collapseBtn}</span>
                                            <Icons.ArrowUp />
                                        </button>
                                    )}
                                </div>
                            </>
                        )}
                    </section>

                    {/* Section Divider */}
                    <SectionDivider />

                    {/* --- CONTACT --- */}
                    <section id="contact" className="pt-12 pb-12 px-6 bg-surface">
                        <div className="container mx-auto max-w-5xl">
                            <h2 className={`section-title text-2xl md:text-4xl font-light mb-12 md:mb-16 text-center text-white ${isRTL ? 'font-fa md:font-bold' : ''}`}>
                                {t.contact.title}
                            </h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" dir="ltr">
                                {socialLinks.map((item, index) => (
                                    <a key={index} href={item.href} target="_blank" onClick={() => haptic.light()} className="contact-card flex items-center gap-4 p-5 rounded-lg border border-white/5 hover:border-accent/50 hover:bg-white/[0.02] transition-all duration-300 group cursor-none text-left backdrop-blur-sm bg-white/[0.01]" style={{ transitionDelay: `${index * 0.05}s` }} onMouseEnter={() => handleHover(true)} onMouseLeave={() => handleHover(false)}>
                                        <span className="text-secondary group-hover:text-accent transition-colors scale-100">{item.icon}</span>
                                        <div className="flex flex-col items-start">
                                            <span className={`text-[9px] uppercase ${isRTL ? 'tracking-normal font-fa font-bold' : 'tracking-widest'} text-secondary mb-1`}>{item.label}</span>
                                            <span className="text-xs md:text-sm font-light text-white">{item.text}</span>
                                        </div>
                                    </a>
                                ))}
                            </div>
                        </div>
                    </section>

                    {/* Section Divider */}
                    <div className="bg-surface"><SectionDivider /></div>

                    {/* --- ABOUT ME --- */}
                    <section id="about" className="pt-12 pb-16 px-6 bg-[#080808]">
                        <div className="container mx-auto max-w-6xl">
                            <div className={`flex flex-col md:flex-row gap-10 md:gap-20`}>
                                <div className={`reveal w-full md:w-1/3 aspect-[3/4] md:aspect-[4/5] relative self-start ${isRTL ? 'order-first' : ''}`}>
                                    <div className="absolute top-2 left-2 w-full h-full border border-white/5 z-0"></div>
                                    <img src="./images/me.jpg" alt="Arian Tabib" className="w-full h-full object-cover relative z-10 transition-all duration-700 hover:scale-[1.02]" />
                                </div>
                                
                                <div className={`w-full md:w-2/3 ${isRTL ? 'text-right' : 'text-left'}`}>
                                    <h2 className={`reveal text-2xl md:text-4xl text-accent uppercase ${isRTL ? 'tracking-normal font-fa font-bold' : 'tracking-[0.2em] font-bold'} mb-3`}>
                                        {t.about.title}
                                    </h2>
                                    <p className={`reveal text-sm md:text-base text-white/60 leading-loose mb-8 font-light ${isRTL ? 'font-fa' : ''}`}>{t.about.bio}</p>

                                    <div className="mt-12">
                                        <h3 className={`reveal text-base md:text-lg font-light text-white mb-6 border-b border-white/5 pb-2 ${isRTL ? 'font-fa md:font-bold' : ''}`}>{t.about.expTitle}</h3>
                                        <div className={`space-y-6 relative ${isRTL ? 'border-r mr-2 pr-6' : 'border-l ml-2 pl-6'} border-white/5`}>
                                            {timeline.experience.map((job, i) => (
                                                <div key={i} className="timeline-item relative" style={{ transitionDelay: `${i * 0.1}s` }}>
                                                    <span className={`absolute ${isRTL ? '-right-[31px]' : '-left-[31px]'} top-1.5 w-2.5 h-2.5 bg-white/20 hover:bg-accent rounded-full border border-black transition-colors`}></span>
                                                    <h4 className={`text-sm font-medium text-white ${isRTL ? 'font-fa md:font-bold' : ''}`}>{job.role}</h4>
                                                    <p className="text-white/40 text-xs mt-1">{job.company}</p>
                                                    <span className={`text-[10px] text-secondary uppercase ${isRTL ? 'tracking-normal font-fa' : 'tracking-wider'} mt-1 block`}>{job.duration}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="mt-12">
                                        <h3 className={`reveal text-base md:text-lg font-light text-white mb-6 border-b border-white/5 pb-2 ${isRTL ? 'font-fa md:font-bold' : ''}`}>{t.about.eduTitle}</h3>
                                        <div className={`space-y-6 relative ${isRTL ? 'border-r mr-2 pr-6' : 'border-l ml-2 pl-6'} border-white/5`}>
                                            {timeline.education.map((edu, i) => (
                                                <div key={i} className="timeline-item relative" style={{ transitionDelay: `${i * 0.1}s` }}>
                                                    <span className={`absolute ${isRTL ? '-right-[31px]' : '-left-[31px]'} top-1.5 w-2.5 h-2.5 bg-accent rounded-full border border-black`}></span>
                                                    <h4 className={`text-sm font-medium text-white ${isRTL ? 'font-fa md:font-bold' : ''}`}>{edu.role}</h4>
                                                    <p className="text-white/40 text-xs mt-1">{edu.company}</p>
                                                    <span className={`text-[10px] text-secondary uppercase ${isRTL ? 'tracking-normal font-fa' : 'tracking-wider'} mt-1 block`}>{edu.duration}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* SKILLS SECTION */}
                            <div className="mt-20">
                                <h3 className={`reveal text-base md:text-lg font-light text-white mb-8 text-center ${isRTL ? 'font-fa md:font-bold' : ''}`}>{t.about.skillsTitle}</h3>
                                <div className="skills-grid" dir="ltr">
                                    {skillsData.map((skill, index) => (
                                        <div key={skill.id} className="skill-item" style={{ transitionDelay: `${index * 0.03}s` }} onMouseEnter={() => handleHover(true)} onMouseLeave={() => handleHover(false)}>
                                            <img src={skill.icon} alt={skill.name} className="skill-icon" onError={(e) => { e.target.onerror = null; e.target.src = `https://placehold.co/44x44/1a1a1a/C1A365?text=${skill.name.charAt(0)}`; }} />
                                            <span className="skill-name">{skill.name}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </section>

                    {/* --- FOOTER --- */}
                    <footer className="py-8 pb-28 md:pb-8 text-center bg-bg border-t border-white/5">
                        <p className={`reveal text-[10px] text-white/20 uppercase ${isRTL ? 'tracking-normal font-fa' : 'tracking-[0.2em]'}`}>{t.footer}</p>
                    </footer>

                    {/* --- MOBILE BOTTOM NAVIGATION --- */}
                    <MobileBottomNav activeSection={activeSection} onNavigate={handleNavClick} lang={lang} onLangToggle={() => setLang(lang === 'en' ? 'fa' : 'en')} isRTL={isRTL} isVisible={mobileNavVisible && !selectedProject} />

                    {/* iPhone USDZ Download Progress Overlay */}
                    {isDownloadingUsdz && (
                        <div className="fixed inset-0 z-[200] flex flex-col items-center justify-center bg-black/95 backdrop-blur-xl">
                            <div className="flex flex-col items-center max-w-sm px-8">
                                <div className="mb-6 text-accent animate-pulse"><Icons.AR /></div>
                                <div className="w-full h-1 bg-white/10 rounded-full overflow-hidden mb-3">
                                    <div className="h-full bg-gradient-to-r from-accent to-yellow-400 transition-all duration-150 ease-out rounded-full" style={{ width: `${usdzDownloadProgress}%` }}></div>
                                </div>
                                <p className={`text-white text-xs font-light uppercase tracking-widest mb-1 ${isRTL ? 'font-fa font-bold' : ''}`}>{lang === 'en' ? 'Preparing AR Experience' : 'آماده‌سازی تجربه AR'}</p>
                                <p className="text-accent text-lg font-mono font-light">{usdzDownloadProgress}%</p>
                            </div>
                        </div>
                    )}

                    {/* --- MODAL --- */}
                    {selectedProject && (
                        <div 
                            className="fixed inset-0 z-50 flex items-center justify-center p-4 md:p-8 bg-black/90 backdrop-blur-xl animate-fade-in" 
                            onClick={handleBackdropClick}
                            style={{ opacity: modalOpacity }}
                        >
                            <div 
                                className="w-full h-full max-w-[1920px] p-4 md:p-12 flex flex-col md:flex-row gap-8 items-center justify-center relative pointer-events-none"
                            >

                                {!showAR && (
                                    <button className="absolute top-4 right-4 z-50 p-2 bg-black/20 hover:bg-white text-white/80 hover:text-black rounded-full transition-all backdrop-blur-md border border-white/10 pointer-events-auto" onClick={() => { haptic.light(); closeModal(); }}>
                                        <Icons.Close />
                                    </button>
                                )}

                                <div className="flex-1 w-full h-[50vh] md:h-full flex items-center justify-center relative pointer-events-auto" onClick={(e) => e.stopPropagation()} onTouchStart={onTouchStart} onTouchMove={onTouchMove} onTouchEnd={onTouchEnd}>
                                    {isImageLoading && showAR && (
                                        <div className="absolute inset-0 flex flex-col items-center justify-center z-[110] bg-black/80 backdrop-blur-sm transition-opacity duration-300">
                                            <div className="w-48 h-0.5 bg-white/10 rounded-full overflow-hidden mb-3">
                                                <div className="h-full bg-accent transition-all duration-100 ease-out" style={{ width: `${loadProgress}%` }}></div>
                                            </div>
                                            <p className="text-white/70 text-[10px] font-light uppercase tracking-widest mb-0.5">{lang === 'en' ? 'Loading Model' : 'در حال بارگذاری'}</p>
                                            <p className="text-accent text-xs font-mono">{loadProgress}%</p>
                                        </div>
                                    )}
                                    {isImageLoading && !showAR && (
                                         <div className="absolute inset-0 flex items-center justify-center z-10">
                                            <div className="w-8 h-8 border-2 border-accent border-t-transparent rounded-full animate-spin"></div>
                                        </div>
                                    )}
                                    {showAR && selectedProject.hasAR ? (
                                        <div className="w-full h-full relative" dir="ltr">
                                            <model-viewer 
                                                ref={modelViewerRef} 
                                                src={selectedProject.modelGLB} 
                                                ios-src={selectedProject.modelUSDZ} 
                                                ar 
                                                ar-modes="webxr scene-viewer quick-look" 
                                                ar-scale="auto" 
                                                ar-placement="floor" 
                                                camera-controls 
                                                auto-rotate 
                                                shadow-intensity="1" 
                                                interaction-prompt="none" 
                                                alt={`3D model of ${selectedProject.title[lang]}`} 
                                                style={{width: '100%', height: '100%'}}
                                            >
                                                {/* AR activation button - this is the ONLY thing in the slot */}
                                                <button 
                                                    slot="ar-button" 
                                                    className="ar-btn ar-btn-activate"
                                                    style={{ position: 'absolute', bottom: '16px', left: '50%', transform: 'translateX(-50%)', zIndex: 60 }}
                                                >
                                                    <span>{lang === 'en' ? 'View in AR' : 'واقعیت افزوده'}</span>
                                                    <Icons.AR />
                                                </button>
                                            </model-viewer>
                                            
                                            {/* Back button - COMPLETELY OUTSIDE model-viewer to prevent AR trigger */}
                                            <button 
                                                onClick={handleCloseARView} 
                                                className="md:hidden ar-btn ar-btn-back"
                                                style={{ position: 'absolute', top: '16px', left: '16px', zIndex: 100, pointerEvents: 'auto' }}
                                            >
                                                <Icons.Back />
                                                <span>{lang === 'en' ? 'Back' : 'بازگشت'}</span>
                                            </button>
                                            
                                            {/* Desktop back button */}
                                            <button onClick={handleCloseARView} className="hidden md:flex absolute top-4 left-4 z-[60] px-4 py-2 bg-black hover:bg-[#222] text-white rounded-full transition-all items-center gap-2 shadow-lg pointer-events-auto text-[10px] font-light uppercase tracking-widest border border-white/10">
                                                <Icons.Back /><span>{lang === 'en' ? 'Back to Gallery' : 'بازگشت'}</span>
                                            </button>
                                        </div>
                                    ) : (
                                        <>
                                            {selectedProject.video && modalImageIndex === selectedProject.gallery.length ? (
                                                <video src={selectedProject.video} controls autoPlay className="max-w-full max-h-full w-auto h-auto object-contain shadow-2xl transition-opacity duration-300" onLoadedData={handleImageLoad}></video>
                                            ) : (
                                                <img src={selectedProject.gallery[modalImageIndex]} onLoad={handleImageLoad} className={`max-w-full max-h-full w-auto h-auto object-contain shadow-2xl transition-opacity duration-300 ${isImageLoading ? 'opacity-0' : 'opacity-100'}`} alt="Project Detail" />
                                            )}
                                            {(selectedProject.gallery.length + (selectedProject.video ? 1 : 0)) > 1 && (
                                                <>
                                                    <button onClick={prevMedia} className="absolute left-4 top-1/2 -translate-y-1/2 p-2 bg-black/20 hover:bg-white/20 backdrop-blur-md rounded-full transition-all z-20 cursor-pointer text-white/70 hover:text-white">
                                                        <Icons.ArrowLeft />
                                                    </button>
                                                    <button onClick={nextMedia} className="absolute right-4 top-1/2 -translate-y-1/2 p-2 bg-black/20 hover:bg-white/20 backdrop-blur-md rounded-full transition-all z-20 cursor-pointer text-white/70 hover:text-white">
                                                        <Icons.ArrowRight />
                                                    </button>
                                                    <div className="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2 z-20">
                                                        {selectedProject.gallery.map((_, idx) => (
                                                            <div key={idx} className={`w-1 h-1 rounded-full transition-all ${idx === modalImageIndex ? 'bg-accent w-3' : 'bg-white/30'}`}></div>
                                                        ))}
                                                        {selectedProject.video && (
                                                            <div className={`w-1 h-1 rounded-full transition-all ${selectedProject.gallery.length === modalImageIndex ? 'bg-accent w-3' : 'bg-white/30'}`}></div>
                                                        )}
                                                    </div>
                                                </>
                                            )}
                                        </>
                                    )}
                                </div>

                                {!showAR && (
                                    <div className={`w-full md:w-[360px] lg:w-[400px] max-h-[40vh] md:max-h-[80vh] flex flex-col bg-[#0a0a0a] border border-white/5 shadow-2xl rounded-sm overflow-hidden pointer-events-auto ${isRTL ? 'text-right font-fa' : 'text-left'}`} dir={isRTL ? 'rtl' : 'ltr'} onClick={(e) => e.stopPropagation()}>
                                        <div className="p-5 md:p-8 overflow-y-auto flex-1 modal-scroll flex flex-col">
                                            <span className={`text-accent text-[10px] uppercase ${isRTL ? 'tracking-normal font-fa font-bold' : 'tracking-[0.15em]'} mb-2 md:mb-3 block opacity-70`}>{selectedProject.loc}</span>
                                            <h2 className={`text-lg md:text-3xl font-light mb-4 md:mb-6 text-white leading-tight ${isRTL ? 'font-fa md:font-bold' : ''}`}>{selectedProject.title[lang]}</h2>
                                            
                                            <div className={`text-white/50 text-sm leading-7 ${isRTL ? 'font-fa' : ''}`}>
                                                {selectedProject.desc[lang]}
                                            </div>

                                            <div className="mt-auto pt-4 md:pt-8"></div> 

                                            <div className={`border-t border-white/5 pt-3 md:pt-5 grid grid-cols-1 gap-1 text-[10px] text-white/30 font-mono ${isRTL ? 'tracking-normal font-fa' : 'tracking-wide'}`}>
                                                <div className="flex justify-between"><span>ROLE:</span> <span className="text-white/60">Lead Architect</span></div>
                                                <div className="flex justify-between"><span>STATUS:</span> <span className="text-white/60">Completed</span></div>
                                            </div>
                                        </div>

                                        {selectedProject.hasAR && (
                                            <div className="p-3 md:p-5 border-t border-white/5 bg-[#0a0a0a] flex justify-end">
                                                <button onClick={handleARButtonClick} disabled={isDownloadingUsdz} className={`px-4 py-2 md:px-5 md:py-2.5 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-accent text-white hover:text-accent rounded-full transition-all flex items-center gap-2 pointer-events-auto font-light uppercase text-[10px] md:text-xs ${isRTL ? 'font-fa font-bold' : 'tracking-widest'} disabled:opacity-50 disabled:cursor-not-allowed`}>
                                                    <span>{isIPhone ? (lang === 'en' ? 'AR' : 'واقعیت افزوده') : (lang === 'en' ? '3D View' : 'نمای سه بعدی')}</span>
                                                    <Icons.AR />
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
